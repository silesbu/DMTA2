---
title: "DMTA2"
author: "S"
date: "14 de mayo de 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Before start:

* Clean the Environment
```{r}
rm(list=ls())
```

* Set path
```{r}
setwd("C:/Users/SILVIA TOSHIBA/Documents/MASTER/Data mining techniques/Assignment 2/Data")
```

Load the data
```{r}
#Load the data
#all_train <- read.csv("train.csv", header = TRUE)
#real_test <- read.csv("test.csv", header = TRUE)

#LOAD A SUBSET OF THE DATA FOR MY OWN COMPUTER, NOT ABLE TO LOAD THE WHOLE DATA
all_train <- read.csv("train.csv",header=TRUE, nrows = 100000)
#real_test <- read.csv("train.csv",header=TRUE, nrows = 1000)
```

Visualize the Data
```{r}
all_train$prop_review_score[is.na(all_train$prop_review_score)] <- "NA"

ggplot(all_train, aes(x=prop_review_score)) + 
  geom_bar()

pre_NA_visual <-table(Rating=all_train$prop_review_score, Booked= as.logical(all_train$booking_bool))
pre_NA_visual <- as.data.frame(prop.table(pre_NA_visual, 1)) # row percentages 
NA_visual <- pre_NA_visual[pre_NA_visual$Rating=="NA"| pre_NA_visual$Rating=="0",]
NA_visual <- NA_visual[NA_visual$Booked==TRUE,]

ggplot(NA_visual, aes(x = Rating, y = Freq)) + geom_bar(stat = "identity", position = position_dodge())
```

```{r}
# Create the ignored column
all_train$ignored_bool <- ifelse(all_train$click_bool == 0 & all_train$booking_bool == 0, 1, 0)
balance_visual <- data.frame(Type = c("click","book", "ignored"), Value=c(sum(all_train$click_bool==1), sum(all_train$booking_bool==1), sum(all_train$ignored_bool==1)))

ggplot(balance_visual, aes(x=Type, y=Value, fill=Type)) + 
  geom_histogram(stat="identity")

# balance_visual <- data.frame(Yes=c(sum(train$click_bool==1), sum(train$booking_bool==1), sum(train$ignored_bool==0)), No = c(sum(train$click_bool==0), sum(train$booking_bool==0), sum(train$ignored_bool==1)), row.names = c("click","book", "ignored"))
# 
# balance_visual <- as.matrix(balance_visual)
# balance_visual <- as.table(balance_visual)
# 
# percentage_balance <- as.data.frame(prop.table(balance_visual, 1)*100) # row percentages 
# 
# 
# ggplot(percentage_balance, aes(x = Var2, y = Freq, fill = Var1)) + 
#   geom_bar(stat = "identity", position = position_dodge())
```
Remove Data
```{r}

```



Split in Train, Test and Validation set
```{r}
library(dplyr)

all_train <- all_train %>%
  group_by(srch_id)

all_length <- nrow(all_train)
splity <- all_length*0.15
test <- all_train[1:splity,]
splited_train <- all_train[(splity+1):all_length,]
# Modify number of cucus depending on the srch_id cutoff

#Second split of the data
dt <- sort(sample(nrow(splited_train), nrow(splited_train)*.82353)) #to have 15% of the real_train.
train <- splited_train[dt,]
validation <- splited_train[-dt,]
#Deletin of the not useful variables
rm(splited_train, dt)
rm(splity, all_length)
```

Data Balance
```{r}
# library(unbalanced)
# 
# 
# #train[c("click", "booking", "unknown")] <- as.factor(train[c("click_bool", "booking_bool", "unknown_bool")]) 
# # Group the data based on "click_bool", "booking_bool", "unknown_bool" variables using dplyr package containing "group by" function
# 
# input <- train[c("click_bool", "booking_bool", "ignored_bool")]
# output <- train
# output$click_bool <- NULL
# output$booking_bool <- NULL
# output$ignored_bool <- NULL
# output <- na.omit(output)
# 
# #balance the dataset
# function_output<-ubUnder(X=input, Y=output, perc=50, method = "percPos")
# balanced_train<-cbind(function_output$X, function_output$Y)
```
```{r}
# balanced<-function(data, ID, TIME, VARS, required=c("all","shared")) {
#     if(is.character(ID)) {
#         ID <- match(ID, names(data))
#     }
#     if(is.character(TIME)) {
#         TIME <- match(TIME, names(data))
#     }
#     if(missing(VARS)) { 
#         VARS <- setdiff(1:ncol(data), c(ID,TIME))
#     } else if (is.character(VARS)) {
#         VARS <- match(VARS, names(data))
#     }
#     required <- match.arg(required)
#     idf <- do.call(interaction, c(data[, ID, drop=FALSE], drop=TRUE))
#     timef <- do.call(interaction, c(data[, TIME, drop=FALSE], drop=TRUE))
#     complete <- complete.cases(data[, VARS])
#     tbl <- table(idf[complete], timef[complete])
#     if (required=="all") {
#         keep <- which(rowSums(tbl==1)==ncol(tbl))
#         idx <- as.numeric(idf) %in% keep
#     } else if (required=="shared") {
#         keep <- which(colSums(tbl==1)==nrow(tbl))
#         idx <- as.numeric(timef) %in% keep
#     }
#     data[idx, ]
# }
# 
# train2 <- train
# balanced(train2, input, output)
```
